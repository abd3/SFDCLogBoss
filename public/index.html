<html>
<head>
<title="SFDC Log Boss"/>
<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<style>
.link-stat {
  display: block;
  font-size: 12px;
}
.log-link {
  display: inline;
  font-size: 12px;
  text-decoration: underline;
}

#soql-deets{
  text-align: left;
  padding: 5px;
}
#qn {
  margin-bottom: 10px;
}
</style>
</head>
<body>
<div class="container">
  <div class="row">
    <div id="qn"><h3>SFDC Log Boss</h3></div>
    <select id="logselect" name="loglist"></select>
  </div>
  <div class="row">
    <div class="col-md-3" id="soql-tots"></div>
    <div class="col-md-8" id="soql-deets"></div>
  </div>
  <div class="row">
    <div id="trigg-tots"></div>
    <div id="trigg-deets"></div>
  </div>
</div>
</body>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/sfdcLogParser.js"></script>
<script>

function loadLog(selectedLog) {
  $('#soql-tots').html('Loading log...')
  var rr = '/logs_/' + selectedLog;
  console.log('Selected Log: ' + rr + '\n');
  //$( '#lograw').html(rr + "\n");
  var jqxhr = $.ajax( rr )
      .done(function(data ) {
      
      sfdcLogParser.processLines(data);
      log(" >> complete processing");

      // update soql totals
      var objCountArr = sfdcLogParser.getSoqlObjectCount();    
      log("> objCount size " + objCountArr.length);
      var soqlCountList = reduce(function(s, x) {
        return s + '<span class="link-stat">' + objCountArr[i].objName + ': <span class="log-link" onclick="showSoqlDeets(\''+objCountArr[i].objName+'\');">' + objCountArr[i].objCount + '</span></span>'},
        objCountArr, "");

      var soqlTotalCount = reduce(function(s, x) {
        var x = objCountArr[i].objCount;
        log(x);
        return s + x;},
        objCountArr, 0);
      log(soqlTotalCount);
      $('#soql-tots').html('<h5>SOQL Object Count: ' + soqlTotalCount + '</h5>' + soqlCountList);

      // update trigger totals
      var triggerCount = sfdcLogParser.getTriggerCount();
      log("> trigg size: " + triggerCount.length);
      var trigCountList = reduce(function(s,x ) {
          return s + '<span class="link-stat">' + triggerCount[i].objName + ': <span class="log-link" onclick="showInfovis();">' + triggerCount[i].objCount + '</span></span>'},
          triggerCount, "");

      $("#trigg-tots").html('<h4>Trigger Count</h4>' + trigCountList);

    })
  };

    function showSoqlDeets(objName) {
      $("#soql-deets").html(sfdcLogParser.getSoqlList(objName));
    }

$( document ).ready(function() {
  var jqxhr = $.ajax( "/loglisting" )
      .done(function(data ) {
      console.log(">> Log Listing: ");
      console.log(data.split(","));
      var loglist = data.split(",");
      var optionsAsString = "<option value='not'>-- select --</option>";
    for(var i = 0; i < loglist.length; i++) {
      if (loglist[i].indexOf(".")>1) {
        optionsAsString += "<option value='" + loglist[i] + "'>" + loglist[i] + "</option>";        
      }
    }
    $( 'select[name="loglist"]' ).append( optionsAsString );
    $( '#logselect' ).change(function() {
      loadLog($( '#logselect' ).val())
      });
    })

});
</script>

</html>
