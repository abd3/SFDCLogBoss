<html>
<head>
<title="SFDC Log Parser"/>
<style>

.link-stat {
  display: block;
  font-size: 14px;
}
.log-link {
  display: inline;
  font-size: 14px;
  text-decoration: underline;
}

#soql-deets{
  text-align: left;
  display: block;
  font-size: 14px;
  margin: 20px;
  float: right;
  width: 70%;
}
#header {
  font-weight: bold;
  font-size: 16px;
  margin: 20px;
}
#soql-tots {
  margin: 0 20px;
  float: left;
}
#trigg-tots{
  margin: 0 20px;
  float: left;
}
#qn {
  margin-bottom: 10px;
}
</style>
</head>
<body>
<div id="header">
  <div id="qn"></div>
  <select id="logselect" name="loglist"></select>
</div>
<div id="soql-deets"></div>
<div id="soql-tots"></div>
<div style="clear:both"></div>
<div id="trigg-tots"></div>
<div id="trigg-deets"></div>
</body>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/js/sfdcLogParser.js"></script>
<script>

function loadLog(selectedLog) {
  $('#soql-tots').html('Loading log...')
  var rr = '/logs_/' + selectedLog;
  console.log('Selected Log: ' + rr + '\n');
  //$( '#lograw').html(rr + "\n");
  var jqxhr = $.ajax( rr )
      .done(function(data ) {
      
      sfdcLogParser.processLines(data);
      log(" >> complete processing");

      // update soql totals
      var objCountArr = sfdcLogParser.getSoqlObjectCount();    
      log("> objCount size " + objCountArr.length);
      var soqlCountList = reduce(function(s, x) {
        return s + '<span class="link-stat">' + objCountArr[i].objName + ': <span class="log-link" onclick="showSoqlDeets(\''+objCountArr[i].objName+'\');">' + objCountArr[i].objCount + '</span></span>'},
        objCountArr, "");

      var soqlTotalCount = reduce(function(s, x) {
        var x = objCountArr[i].objCount;
        log(x);
        return s + x;},
        objCountArr, 0);
      log(soqlTotalCount);
      $('#soql-tots').html('<h3>SOQL Object Count: ' + soqlTotalCount + '</h3>' + soqlCountList);

      // update trigger totals
      var triggerCount = sfdcLogParser.getTriggerCount();
      log("> trigg size: " + triggerCount.length);
      var trigCountList = reduce(function(s,x ) {
          return s + '<span class="link-stat">' + triggerCount[i].objName + ': <span class="log-link" onclick="showInfovis();">' + triggerCount[i].objCount + '</span></span>'},
          triggerCount, "");

      $("#trigg-tots").html('<h3>Trigger Count</h3>' + trigCountList);

    })
  };

    function showSoqlDeets(objName) {
      //$("#infovis").css("display","none");
      // load selected soql details 
      /*
      var soqlList = reduce(function(s, x) {
        return s + '<span class="link-stat"><span class="log-link">' + objCount[i].objName + '</span>: ' + objCount[i].objCount + '</span>'},
        getSoqlList(objName), "");
      */
      $("#soql-deets").html(sfdcLogParser.getSoqlList(objName));
      $("#soql-deets").css("display","block");  
    }

$( document ).ready(function() {
  $("#qn").html('SFDC Log Boss');

  var jqxhr = $.ajax( "/loglisting" )
      .done(function(data ) {
      console.log(">> Log Listing: ");
      console.log(data.split(","));
      var loglist = data.split(",");
      var optionsAsString = "<option value='not'>-- select --</option>";
    for(var i = 0; i < loglist.length; i++) {
      if (loglist[i].indexOf(".")>1) {
        optionsAsString += "<option value='" + loglist[i] + "'>" + loglist[i] + "</option>";        
      }
    }
    $( 'select[name="loglist"]' ).append( optionsAsString );
    $( '#logselect' ).change(function() {
      loadLog($( '#logselect' ).val())
      });
    })

});
</script>

</html>
